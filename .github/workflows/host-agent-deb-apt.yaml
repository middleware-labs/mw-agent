name: Host Agent DEB + APT Package

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version for DEB + APT package'
        required: true
  push:
    paths-ignore:
      - '.github/**'
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

env:
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        arch:
          #- arm64
          - amd64
      max-parallel: 1

    steps:
    - name: Free up disk space
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        echo "=== Disk space before cleanup ==="
        df -h /
        
        # Remove large unnecessary packages
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/share/swift
        
        # Remove Docker images if not needed
        sudo docker image prune -af || true
        
        # Clean apt cache
        sudo apt-get clean
        
        echo "=== Disk space after cleanup ==="
        df -h /

    - name: Install rpm build for ACT runs
      if: ${{ github.actor == 'nektos/act' }}
      run: |
        sudo apt-get update
        sudo apt-get install -y gettext-base
  
    - name: Checkout MW Agent Repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GHCR_TOKEN }}
        ssh-key: ${{ secrets.CHECK_AGENT_ACCESS }}
        submodules: 'recursive'
        path: agent

    - name: Checkout MW Supervisor Repo
      uses: actions/checkout@v4
      with:
        repository: middleware-labs/mw-opampsupervisor 
        token: ${{ secrets.GHCR_TOKEN }}
        submodules: 'recursive'
        path: supervisor
        ref: beta

    - name: Set Architecture Variables
      run: |
        echo "PACKAGE_NAME=mw-agent" >> $GITHUB_ENV
        echo "AGENT_BINARY=release/mw-agent" >> $GITHUB_ENV
        echo "SUPERVISOR_BINARY=release/mw-opamp-supervisor" >> $GITHUB_ENV
        if [ -n "${{ github.event.inputs.release_version }}" ]; then
          echo "RELEASE_VERSION=${{ github.event.inputs.release_version }}" >> $GITHUB_ENV
        else
          echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
        fi
    
    # Reference : https://www.debian.org/doc/debian-policy/ch-controlfields.html
    - name: Creating Required Folder Structure
      run: |
        mkdir -p build/apt-repo
        mkdir -p build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/opt/${PACKAGE_NAME}/bin

    - name: Set up Go
      if: ${{ github.actor != 'nektos/act' }}
      uses: actions/setup-go@v4
      with:
        go-version: 1.24.0

    - name: Set up Git credentials for Go
      run: |
        git config --global url."https://${{ secrets.GHCR_TOKEN }}:@github.com/".insteadOf "https://github.com/"
      env:
        GITHUB_TOKEN: ${{ secrets.GHCR_TOKEN }}

    # Building with CGO_ENABLED=0 so that we can build static binary which is not dependent on any external libraries
    # Building with -ldflags="-s -w" to reduce the size of binary
    - name: Go Build
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        cd agent
        CGO_ENABLED=0 GOPRIVATE=github.com/middleware-labs GOOS=linux GOARCH=${{ matrix.arch }} go build -ldflags="-s -w -X main.agentVersion=${RELEASE_VERSION}" -v -a -o ../${AGENT_BINARY} cmd/host-agent/main.go

    - name: Build Supervisor Binary
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        cd supervisor
        CGO_ENABLED=0 GOPRIVATE=github.com/middleware-labs \
          GOOS=linux GOARCH=${{ matrix.arch }} \
          go build -ldflags="-s -w -X main.version=${RELEASE_VERSION}" \
          -v -a -o ../${SUPERVISOR_BINARY} .

    - name: Clean Go cache to free space
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        go clean -cache -modcache
        echo "=== Disk space after Go cleanup ==="
        df -h /
        
    - name: Copying code binary into target location
      run: |
          if [ ${{ github.actor }} == "nektos/act" ]
          then
              cp build/mw-host-agent-${{ matrix.arch }} build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}
              cp build/mw-opamp-supervisor-${{ matrix.arch }} build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/opt/${PACKAGE_NAME}/bin/mw-opamp-supervisor
          else 
            # For GitHub Actions, copy freshly built binaries
            cp $AGENT_BINARY build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/opt/${PACKAGE_NAME}/bin/${PACKAGE_NAME}
            cp ${SUPERVISOR_BINARY} build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/opt/${PACKAGE_NAME}/bin/mw-opamp-supervisor
          fi

    - name: Copy Linux root files & generate dpkg Control file
      run: |
          mkdir -p build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN
          mkdir -p build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}
          mkdir -p build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}/opamp
          mkdir -p build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/lib/systemd/system

          cp agent/package-tooling/agent-config.yaml.sample build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}/agent-config.yaml.sample
          cp agent/package-tooling/mw-agent.env.sample build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}/mw-agent.env.sample
          # cp agent/package-tooling/mw-supervisor.env build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}/mw-supervisor.env
          cp agent/package-tooling/otel-config.yaml.sample build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}/otel-config.yaml.sample
          cp supervisor/package-tooling/supervisor-config.yaml.sample build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/etc/${PACKAGE_NAME}/supervisor-config.yaml.sample

          cp agent/package-tooling/linux/postinst build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/postinst
          cp agent/package-tooling/linux/prerm build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/prerm
          cp agent/package-tooling/linux/postrm build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/postrm
          chmod 0755 build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/postinst
          chmod 0755 build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/prerm
          chmod 0755 build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/postrm

          cp agent/package-tooling/linux/mw-agent.service build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/lib/systemd/system/mw-agent.service
          cp agent/package-tooling/linux/mw-agent-opamp.service build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/lib/systemd/system/mw-agent-opamp.service

          cd agent
          PACKAGE=${PACKAGE_NAME} VERSION=${RELEASE_VERSION} ARCHITECTURE=${{ matrix.arch }} \
            envsubst < package-tooling/linux/deb/control > \
            ../build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/control
          # cd agent
          # PACKAGE=${PACKAGE_NAME} VERSION=${RELEASE_VERSION} ARCHITECTURE=${{ matrix.arch }} envsubst < package-tooling/linux/deb/control > build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}/DEBIAN/control

    - name: Creating DEB package
      run: |
          dpkg-deb --build -Z xz build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}
          dpkg-deb --info build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}.deb
          dpkg-deb --contents build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}.deb

    - name: Upload DEB as artifact
      if: ${{ github.actor != 'nektos/act' }}
      uses: actions/upload-artifact@v4
      with:
        name: mw-agent-${{ matrix.arch }}-deb
        path: build/mw-agent_${{ env.RELEASE_VERSION }}_${{ matrix.arch }}.deb
        retention-days: 1
    
    - name: Upload agent binary as artifact
      if: ${{ github.actor != 'nektos/act' }}
      uses: actions/upload-artifact@v4
      with:
        name: mw-agent-${{ matrix.arch }}-binary
        path: release/mw-agent
        retention-days: 1

    - name: Clean up build artifacts to free space
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        # Remove the package directory (keep only the .deb file)
        rm -rf build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}
        rm -rf release/
        echo "=== Disk space after build cleanup ==="
        df -h /

    - name: Set up aptly
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        # Download aptly binary
        wget https://github.com/aptly-dev/aptly/releases/download/v1.5.0/aptly_1.5.0_linux_amd64.tar.gz
        tar -xzf aptly_1.5.0_linux_amd64.tar.gz
        chmod +x aptly_1.5.0_linux_amd64/aptly
         
        # Move aptly binary to a directory in PATH
        sudo mv aptly_1.5.0_linux_amd64/aptly /usr/local/bin/
        
        # Clean up downloaded archive
        rm -rf aptly_1.5.0_linux_amd64.tar.gz aptly_1.5.0_linux_amd64/

    - name: Verify aptly version
      if: ${{ github.actor != 'nektos/act' }}
      run: aptly version

    # Reference : https://www.aptly.info/doc/
    - name: Add DEB to MW APT Repo
      if: ${{ github.actor != 'nektos/act' }}
      run: |
        echo "=== Disk space before APT repo operations ==="
        df -h /
        
        sudo apt-get install -y gnupg
        
        # Clone with sparse-checkout including all necessary directories
        git clone --depth=1 --filter=blob:none --no-checkout https://.:${{ secrets.GHCR_TOKEN }}@github.com/middleware-labs/apt.middleware.io.git
        cd apt.middleware.io
        git sparse-checkout init --cone
        git sparse-checkout set db gpg-keys pool public
        git checkout
        
        echo "=== APT repo size after checkout ==="
        du -sh .
        du -sh */ 2>/dev/null || true
        
        # Ensure directories exist
        mkdir -p db public pool
        chmod 755 db public pool
        
        cd ..
        
        gpg --import apt.middleware.io/gpg-keys/mw-agent-apt-private.key
        gpg --import apt.middleware.io/gpg-keys/mw-agent-apt-public.key
        
        # Configure aptly to use the cloned repo directory directly (avoids copying)
        APTLY_HOME=$(pwd)/apt.middleware.io
        echo "APTLY_HOME=$APTLY_HOME" >> $GITHUB_ENV
        
        # Create aptly config pointing to the cloned directory
        echo '{"rootDir":"'"$APTLY_HOME"'","downloadConcurrency":4,"downloadSpeedLimit":0,"architectures":[],"dependencyFollowSuggests":false,"dependencyFollowRecommends":false,"dependencyFollowAllVariants":false,"dependencyFollowSource":false,"dependencyVerboseResolve":false,"gpgDisableSign":false,"gpgDisableVerify":false,"gpgProvider":"gpg","downloadSourcePackages":false,"skipLegacyPool":true,"ppaDistributorID":"ubuntu","ppaCodename":"","skipContentsPublishing":false,"FileSystemPublishEndpoints":{},"S3PublishEndpoints":{},"SwiftPublishEndpoints":{}}' > ~/.aptly.conf
        cat ~/.aptly.conf
        
        echo "=== Disk space after setup ==="
        df -h /
        
        aptly repo list
        aptly repo add --force-replace mw-repo build/${PACKAGE_NAME}_${RELEASE_VERSION}_${{ matrix.arch }}.deb
        aptly repo list
        gpg --list-keys
        gpg --list-secret-keys
        
        ls -l $APTLY_HOME/pool
        aptly publish update -force-overwrite stable
        
        echo "=== Disk space after aptly publish ==="
        df -h /
        
        cd apt.middleware.io
        git config --global user.email "keval@middleware.io"
        git config --global user.name "bhogayatakb"
        git add .
        git commit -m "apt.middleware.io updated"
        git push origin master
# distribution = stable, wheezy
# architectures = all, amd64, arm64
# component = main, contrib, non-free

  upload-to-release:
    needs: build
    if: ${{ github.actor != 'nektos/act' }}
    runs-on: ubuntu-latest
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Set up GitHub CLI
      run: |
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y

    - name: Create and upload to release
      env:
        GITHUB_TOKEN: ${{ secrets.GHCR_TOKEN }}
      run: |
        VERSION="${{ github.event.inputs.release_version }}"
        if [ -z "$VERSION" ]; then
          VERSION="${GITHUB_REF#refs/tags/}"
        fi
        
        # Debug info
        echo "VERSION: $VERSION"
        echo "Artifacts directory content:"
        ls -R ./artifacts
        
        # For each architecture
        for arch in arm64 amd64; do
          echo "Processing $arch architecture"
          FILE="./artifacts/mw-agent-${arch}-deb/mw-agent_${VERSION}_${arch}.deb"
          if [ -f "$FILE" ]; then
            echo "Uploading $FILE to release $VERSION"
            gh release upload "$VERSION" "$FILE" --clobber --repo ${{ github.repository }}
          else
            echo "Warning: $FILE not found"
            echo "Checking actual file path:"
            find ./artifacts -type f -name "*.deb"
            FOUND_FILE=$(find ./artifacts -type f -name "*.deb" | grep "${arch}" | head -n 1)
            if [ ! -z "$FOUND_FILE" ]; then
              echo "Found file at $FOUND_FILE, attempting upload"
              gh release upload "$VERSION" "$FOUND_FILE" --clobber --repo ${{ github.repository }}
            fi
          fi
        done

        echo ""
        echo "=== Creating and uploading agent tarballs ==="
        for arch in arm64 amd64; do
          BINARY_FILE="./artifacts/mw-agent-${arch}-binary/mw-agent"
          if [ -f "$BINARY_FILE" ]; then
            # Create tarball directory
            TARBALL_DIR="mw-agent-${VERSION}-${arch}"
            mkdir -p "$TARBALL_DIR"

            cp "$BINARY_FILE" "$TARBALL_DIR/mw-agent"
            chmod +x "$TARBALL_DIR/mw-agent"

             # Create VERSION file
            echo "$VERSION" > "$TARBALL_DIR/VERSION"
            
            # Create tarball
            tar -czf "mw-agent-${VERSION}-${arch}.tar.gz" "$TARBALL_DIR"
            
            echo "Uploading: mw-agent-${VERSION}-${arch}.tar.gz"
            gh release upload "$VERSION" "mw-agent-${VERSION}-${arch}.tar.gz" --clobber --repo ${{ github.repository }}
            
            # Cleanup
            rm -rf "$TARBALL_DIR"
          else
            echo "Warning: Binary not found at $BINARY_FILE"
          fi
        done

        echo ""
        echo "Upload complete! Release assets:"
        echo "  - mw-agent_${VERSION}_amd64.deb"
        echo "  - mw-agent_${VERSION}_arm64.deb"
        echo "  - mw-agent-${VERSION}-amd64.tar.gz"
        echo "  - mw-agent-${VERSION}-arm64.tar.gz"


   
