name: Integration Testing

on:
  push:
    branches:
      - "*"

jobs:
  integration_testing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: k8s-integration-testing

      - name: Kafka Installation
        run: |
          helm repo add cloudhut https://raw.githubusercontent.com/cloudhut/charts/master/archives
          helm repo update
          helm upgrade --install kafka   --namespace kafka-demo   --create-namespace   --set broker.combinedMode.enabled="true"   --set broker.persistence.enabled="false"   kafka-repo/kafka
          sleep 10

      - name: Install MW Agent
        run: |
          export KAFKA_BROKER=$(kubectl -n kafka-demo get services kafka-broker -o jsonpath='{.spec.clusterIP}'):9092 
          bash -c "$(cat install-kube-agent/mw-kube-agent-install.sh)"
          sleep 100
          kubectl delete ns mw-agent-ns
          sleep 10

      - name: Run integration test
        run: |
          export KAFKA_BOOTSTRAP_SERVER=$KAFKA_BROKER
          envsubst < integration_test/integration-test-deployment.yaml | kubectl apply -f -
          

#          i=1
#          while true
#          do
#            echo "check $i"
#            echo $(kubectl get pods -n "mw-agent-ns" --no-headers=true | awk '{print $3}')
#            echo $(kubectl logs -n mw-agent-ns $pod_name)
#            i=$i+1
#            sleep 10
#          done
